/**
 * GAIA -> Google Docs Template Merge -> PDF Base64
 * - organisation_id ile Google Sheet'ten template + folder bulur
 * - Yeni JSON (req.DOSYALAR) alanlarını eski placeholder anahtarlarına map'ler
 * - Dokümanı kopyalar, {{KEY}} placeholder'larını doldurur, PDF base64 döner
 * - Response: organisation_id + unique id + filename + base64
 */


const TENANT_SHEET_ID = '1Op0apkXwX0aQo7d87cybwaNkgcpcTlP-vHf5t_sfuEU';
const TENANT_SHEET_GID = 605323814;
const VEKILSIZ_TEMPLATE_ID = '1DovsQE15jRz0jgTkOUe9sUaT-8ovI6pu6XpDh8GBs_8';


function doPost(e) {
  try {
    const req = JSON.parse(e.postData.contents || '{}');


    // Yeni payload: her şey DOSYALAR altında
    const payload = req.DOSYALAR || {};
    const organisationId = String(payload.organisation_id || req.organisation_id || '').trim();
    if (!organisationId) throw new Error('organisation_id bulunamadı (req.DOSYALAR.organisation_id bekleniyor).');


    // unique id: GAIA gönderiyorsa onu kullan; yoksa timestamp üret
    const uniqueId = String(payload.id || req.id || '').trim() || ('doc-' + Date.now());


    // 1) Sheet’ten tenant/config bul
    const cfg = getTenantConfigByOrganisationId_(organisationId);
    if (!cfg) throw new Error('Bu organisation_id için sheet satırı bulunamadı: ' + organisationId);


    // 2) JSON -> placeholders (eski FIXED_KEYS formatına)
    const placeholders = buildPlaceholdersFromPayload_(payload);


    // 3) Dinamik alanlar + formatlar
    prepareDynamicFields(placeholders);
    formatAmountsTR(placeholders);


    // yüzde alanları
    placeholders.Kusur_Orani_Yuzde = asPercent(placeholders.Kusur_Orani);
    placeholders.On_Odeme_Komisyon_Orani_Yuzde = asPercent(placeholders.On_Odeme_Komisyon_Orani);


    // Dosya adı
    const filenameBase = `İhtar-${placeholders['Davaci_Plaka'] || 'Tur'}-${placeholders['Davaci_Ad_Soyad'] || 'Dosya'}`;
    const filename = filenameBase + ".pdf";


    // 4) Doğru template’i seç + çıktı klasörü
    const templateId = pickIhtarTemplateId_(cfg, placeholders);
    const folderId = String(cfg.drive_folder_id_cikti_ihtar || cfg.drive_folder_id || '').trim();


    // 5) Kopyala + merge + pdf
    const docId = copyTemplate(templateId, filenameBase, folderId);
    mergePlaceholdersStrict(docId, placeholders);


    const pdfB64 = exportPdfBase64(docId);


    return json({
      ok: true,
      organisation_id: organisationId,
      id: uniqueId,
      filename: filename,
      base64: pdfB64,
      docId: docId // istersen kaldır
    });


  } catch (err) {
    return json({ ok: false, error: String(err) });
  }
}


/** ŞABLONUN EVRENSEL ALAN SETİ */
const FIXED_KEYS = [
  'Vekil_Adi','Vekil_TCKN_VKN','Vekil_Adresi','Vekil_IBAN','Vekil_Tel','Vekil_E_Mail','Vekil_Kep',
  'Vekil_Buro_IBAN','Vekil_Buro_Tel','Vekil_Buro_e_mail','Vekil_Banka_Adi','Vekil_Banka_Subesi',


  'Davaci_Ad_Soyad','Davaci_TCKN_VKN','Davaci_Adresi','Davaci_Tel','Davaci_Email','Davaci_Kep','Davaci_IBAN',
  'Vekalet_Tarihi',


  'Kaza_Tarihi','Kaza_Saati','Kaza_Yeri','Kaza_Ozeti','Kaza_Analiz',


  'Davaci_Sase_No','Davaci_Plaka','Davaci_Marka_Model','Davaci_Arac','Davaci_Arac_Surucusu',


  'Karsi_Ad_Soyad','Karsi_TCKN_VKN','Karsi_Marka_Model','Karsi_Plaka','Karsi_Arac','Karsi_Arac_Surucusu',
  'Karsi_Police_Turu','Karsi_Police_No','Karsi_Police_Bas_Tarihi','Karsi_Police_Bitis_Tarihi',


  'Davali_Adi','Davali_Adresi','Davali_Mail','Davali_Kep',


  'Kusur_Orani','Kusur_Orani_Yuzde',


  'SBM_Dosya_No','Hasar_Dosya_No','Eksper_Dosya_No',


  'Davali_Evrak_Talep_Tarihi','Ihtar_Tarihi','Ihtar_Cevap_Durumu','Ihtar_Cevap_Tarihi',


  'Talep_Turu','Talep_Kalemleri',


  'Talep_Tutari_DK','Talep_Tutari_HF','Talep_Tutari_DK_HF','Talep_Tutari_AMB',
  'Talep_Tutari_EksperRaporUcreti','Talep_Tutari_Toplam',


  'Hasar_Onarim_Tutari','Arac_Kilometresi',


  'Eksper_Adi','Eksper_Mail','Eksper_Telefon','Eksper_Rapor_No','Eksper_Rapor_Tarihi',
  'Eksper_DK_Tutari','Eksper_HF_Tutari','Eksper_AMB_Tutari',


  'Ihtar_On_Odeme_Tutari','Ihtar_On_Odeme_Tarihi','On_Odeme_Komisyon_Orani','On_Odeme_Komisyon_Orani_Yuzde',


  'Ihtar_Temerrut_Tarihi','Faiz_Baslangic_Tarihi',


  'Tahkim_Basvuru_Tarihi','Tahkim_Basvuru_Ucreti','Bilirkisi_Odeme_Tutari','Bilirkisi_Odeme_Tarihi',
  'Tahkim_Karar_Tarihi','Tahkim_Uyusmazlik_Tutari','Tahkim_Parasal_Esik_Durumu',
  'Tahkim_Itiraz_Basvuru_Tarihi','Tahkim_Itiraz_Karar_Tarihi',


  'Mahkeme','Esas_No','Islah_Basvuru_Tarihi','Dava_Acilis_Tarihi','Dava_Bilirkisi_Rapor_Tarihi',
  'Dava_Hukum_Tarihi','Dava_Hukum_Tutari','Kanun_Yolu',


  'Tahsilat_Tutari','Tahsilat_Tarihi',


  'Masraf_Vekalet_Ucreti',


  'Servis_Adi','Servis_IBAN','Servis_Telefon',


  'Ihtar_Dilekcesi_Ekler','Ihtar_Ekler',


  'Tahkim_Deliller'
];




/** === DROPDOWN -> TALEP BAYRAKLARI (checkbox'lar kalktı) === */
function hasValue_(v) {
  if (v === null || v === undefined) return false;
  return String(v).trim() !== '';
}

function applyAltBransToClaims_(map) {
  const hasDK = hasValue_(map['Talep_Tutari_DK']);
  const hasHF = hasValue_(map['Talep_Tutari_HF']);

  if (!hasDK && !hasHF) return;

  map['Deger_Kaybi_Talebi'] = hasDK;
  map['Hasar_Farki_Talebi'] = hasHF;
}

/** === DİNAMİK ALANLAR === */
function prepareDynamicFields(map) {
  const DATE_KEYS = [
    'Vekalet_Tarihi','Kaza_Tarihi','Ihtar_Tarihi','Davali_Evrak_Talep_Tarihi','Eksper_Rapor_Tarihi',
    'Ihtar_Cevap_Tarihi','Ihtar_On_Odeme_Tarihi','Ihtar_Temerrut_Tarihi','Faiz_Baslangic_Tarihi',
    'Bilirkisi_Odeme_Tarihi','Tahkim_Basvuru_Tarihi','Tahkim_Karar_Tarihi','Tahkim_Itiraz_Basvuru_Tarihi',
    'Tahkim_Itiraz_Karar_Tarihi','Dava_Acilis_Tarihi','Islah_Basvuru_Tarihi','Dava_Bilirkisi_Rapor_Tarihi',
    'Dava_Hukum_Tarihi','Tahsilat_Tarihi','Karsi_Police_Bas_Tarihi','Karsi_Police_Bitis_Tarihi'
  ];
  for (const k of DATE_KEYS) if (map[k]) map[k] = formatDateTR(map[k]);


  // Checkboxlar kaldırıldığında talep bayraklarını dropdown'dan üret
  applyAltBransToClaims_(map);

  const ITEMS = [
    { on:'Deger_Kaybi_Talebi', amt:'Talep_Tutari_DK',  label:'DEĞER KAYBI BEDELİ', generic:'Değer Kaybı bedeli' },
    { on:'Hasar_Farki_Talebi', amt:'Talep_Tutari_HF',  label:'HASAR FARKI BEDELİ', generic:'Hasar Farkı bedeli' },
    { on:'AMB_Talebi',         amt:'Talep_Tutari_AMB', label:'AMB BEDELİ',         generic:'AMB bedeli' },
  ];


  const parts = [];
  for (const it of ITEMS) {
    if (isTrue(map[it.on])) {
      const n = toNumber(map[it.amt]);
      if (!isNaN(n)) parts.push(`${formatTRY(n)} ${it.label}`);
      else parts.push(it.generic || it.label);
    }
  }


  // Ekspertiz: checkbox kaldırıldı. "Talep Tutarı Eksper R Ücreti" doluysa ekle.
  if (hasValue_(map['Talep_Tutari_EksperRaporUcreti'])) {
    const nExp = toNumber(map['Talep_Tutari_EksperRaporUcreti']);
    if (!isNaN(nExp)) parts.push(`${formatTRY(nExp)} EKSPERTİZ BEDELİ`);
    else parts.push('Ekspertiz bedeli');
  }



  if (parts.length === 1) map['Talep_Kalemleri'] = parts[0];
  else if (parts.length === 2) map['Talep_Kalemleri'] = parts.join(' ve ');
  else if (parts.length > 2) map['Talep_Kalemleri'] = parts.slice(0, -1).join(', ') + ' ve ' + parts[parts.length - 1];
  else if (!hasValue_(map['Talep_Kalemleri'])) map['Talep_Kalemleri'] = '';


  let turParts = [];
  if (isTrue(map['Deger_Kaybi_Talebi'])) turParts.push('Değer Kaybı');
  if (isTrue(map['Hasar_Farki_Talebi'])) turParts.push('Hasar Farkı');


  if (turParts.length > 1) map['Talep_Turu'] = turParts.join(' ve ');
  else if (turParts.length === 1) map['Talep_Turu'] = turParts[0];
  else if (!hasValue_(map['Talep_Turu'])) map['Talep_Turu'] = '';
}


function isTrue(v) {
  if (typeof v === 'boolean') return v;
  if (typeof v === 'number') return v !== 0;
  if (v == null) return false;
  const s = String(v).trim().toLowerCase();
  return s === 'true' || s === '1' || s === 'on' || s === 'yes';
}


function formatTRY(n) {
  try {
    if (n === null || n === undefined || n === '') return '';
    var num = Number(String(n).replace(/[^\d.-]/g, ''));
    if (isNaN(num)) return String(n);
    var isNeg = num < 0;
    var absInt = Math.floor(Math.abs(num)).toString();
    var withDots = absInt.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    return (isNeg ? '-' : '') + withDots + ' TL';
  } catch (e) {
    return String(n);
  }
}


function formatAmountsTR(map) {
  if (!map || typeof map !== 'object') return map;
  var AMOUNT_KEYS = [
    'Hasar_Onarim_Tutari','Talep_Tutari_EksperRaporUcreti','Talep_Tutari_Toplam',
    'Bilirkisi_Odeme_Tutari','Ihtar_On_Odeme_Tutari','Tahkim_Uyusmazlik_Tutari',
    'Tahsilat_Tutari','Talep_Tutari_DK','Talep_Tutari_HF','Talep_Tutari_AMB',
    'Tahkim_Basvuru_Ucreti','Dava_Hukum_Tutari'
  ];
  AMOUNT_KEYS.forEach(function(k){
    if (map[k] !== undefined && map[k] !== null && map[k] !== '') map[k] = formatTRY(map[k]);
  });
  return map;
}


function formatDateTR(input) {
  try {
    if (!input) return '';
    if (typeof input === 'string' && /^\d{4}-\d{2}-\d{2}T/.test(input)) {
      const [yyyy, mm, dd] = input.slice(0, 10).split('-');
      return `${dd}.${mm}.${yyyy}`;
    }
    if (typeof input === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(input)) {
      const [yyyy, mm, dd] = input.split('-');
      return `${dd}.${mm}.${yyyy}`;
    }
    if (typeof input === 'string' && /^\d{1,2}[./]\d{1,2}[./]\d{4}$/.test(input)) {
      const parts = input.split(/[./]/);
      const dd = parts[0].padStart(2, '0');
      const mm = parts[1].padStart(2, '0');
      const yyyy = parts[2];
      return `${dd}.${mm}.${yyyy}`;
    }
    const d = new Date(input);
    if (isNaN(d.getTime())) return String(input);
    const dd = String(d.getUTCDate()).padStart(2, '0');
    const mm = String(d.getUTCMonth() + 1).padStart(2, '0');
    const yyyy = d.getUTCFullYear();
    return `${dd}.${mm}.${yyyy}`;
  } catch (e) {
    return String(input);
  }
}


function toNumber(v) {
  if (typeof v === 'number') return v;
  if (!v) return NaN;
  const s = String(v).replace(/\./g, '').replace(',', '.');
  return Number(s);
}


function mergePlaceholdersStrict(docId, map) {
  const doc = DocumentApp.openById(docId);
  const body = doc.getBody();
  const esc = s => String(s).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');


  for (const k of FIXED_KEYS) {
    const val = map[k] == null ? '' : String(map[k]);
    const pattern = '\\{\\{' + esc(k) + '\\}\\}';
    body.replaceText(pattern, val);
  }
  doc.saveAndClose();
}


function asPercent(n) {
  try {
    if (n === null || n === undefined || n === '') return '';
    var s = String(n).trim();
    var m = s.match(/-?\d+(?:[.,]\d+)?/);
    var num = m ? m[0] : s.replace(/[^\d.-]/g, '');
    var v = Number(num.replace(/\./g, '').replace(',', '.'));
    if (isNaN(v)) return String(n);
    return '%' + Math.round(v);
  } catch (e) {
    return String(n);
  }
}


function copyTemplate(templateId, name, folderId) {
  const f = DriveApp.getFileById(templateId);
  const copy = folderId ? f.makeCopy(name, DriveApp.getFolderById(folderId)) : f.makeCopy(name);
  return copy.getId();
}


function exportPdfBase64(fileId) {
  const blob = DriveApp.getFileById(fileId).getAs(MimeType.PDF);
  return Utilities.base64Encode(blob.getBytes());
}


function json(o) {
  return ContentService.createTextOutput(JSON.stringify(o))
    .setMimeType(ContentService.MimeType.JSON);
}


/* ==========================
   SHEET LOOKUP (organisation_id)
   ========================== */


function getTenantConfigByOrganisationId_(organisationId) {
  const ss = SpreadsheetApp.openById(TENANT_SHEET_ID);
  const sheet = getSheetByGid_(ss, TENANT_SHEET_GID) || ss.getSheets()[0];
  const values = sheet.getDataRange().getValues();
  if (!values || values.length < 2) return null;


  const headers = values[0].map(h => String(h || '').trim());
  const idx = indexByHeader_(headers);


  const orgCol = idx['organisation_id'];
  if (orgCol == null) throw new Error('Sheet header içinde "organisation_id" bulunamadı.');


  for (let r = 1; r < values.length; r++) {
    const row = values[r];
    const org = String(row[orgCol] || '').trim();
    if (org === String(organisationId).trim()) {
      const out = {};
      headers.forEach((h, i) => out[h] = row[i]);
      return out;
    }
  }
  return null;
}


function getSheetByGid_(ss, gid) {
  const sheets = ss.getSheets();
  for (const sh of sheets) if (sh.getSheetId() === Number(gid)) return sh;
  return null;
}


function indexByHeader_(headers) {
  const m = {};
  headers.forEach((h, i) => { if (h) m[h] = i; });
  return m;
}


/* ==========================
   PAYLOAD -> PLACEHOLDERS (KEYMAP)
   ========================== */


function buildPlaceholdersFromPayload_(payload) {
  const p = {};
  applyKeyMap_(p, payload);
  if (payload.Vekil && typeof payload.Vekil === 'object') applyKeyMap_(p, payload.Vekil);
  if (payload.Davalı && typeof payload.Davalı === 'object') applyKeyMap_(p, payload.Davalı);
  for (const k in p) if (typeof p[k] === 'string') p[k] = p[k].trim();
  applyDavaliDirectory_(p);
  return p;
}


const KEYMAP = {
  // Vekil
  'Vekil Adı': 'Vekil_Adi',
  'Vekil TCKN/VKN': 'Vekil_TCKN_VKN',
  'Vekil Adresi': 'Vekil_Adresi',
  'Vekil IBAN': 'Vekil_IBAN',
  'Vekil Tel': 'Vekil_Tel',
  'Vekil E-Mail': 'Vekil_E_Mail',
  'Vekil E- Mail': 'Vekil_E_Mail',
  'Vekil Kep': 'Vekil_Kep',
  'Vekil Büro IBAN': 'Vekil_Buro_IBAN',
  'Vekil Büro Tel': 'Vekil_Buro_Tel',
  'Vekil Büro E-Mail': 'Vekil_Buro_e_mail',
  'Vekil Büro E- Mail': 'Vekil_Buro_e_mail',
  'Vekil Banka Adı': 'Vekil_Banka_Adi',
  'Vekil Banka Şubesi': 'Vekil_Banka_Subesi',


  // Davacı
  'Davacı Ad Soyad': 'Davaci_Ad_Soyad',
  'Davacı TCKN/VKN': 'Davaci_TCKN_VKN',
  'Davacı Adresi': 'Davaci_Adresi',
  'Davacı Tel': 'Davaci_Tel',
  'Davacı Telefon': 'Davaci_Tel',
  'Davacı Email': 'Davaci_Email',
  'Davacı E-Mail': 'Davaci_Email',
  'Davacı Kep': 'Davaci_Kep',
  'Davacı IBAN': 'Davaci_IBAN',
  'Davacı Plaka': 'Davaci_Plaka',
  'Davacı Marka Model': 'Davaci_Marka_Model',
  'Davacı Şase No': 'Davaci_Sase_No',
  'Davacı Araç': 'Davaci_Arac',
  'Davacı Araç Sürücüsü': 'Davaci_Arac_Surucusu',


  // Karşı
  'Karşı Ad Soyad': 'Karsi_Ad_Soyad',
  'Karşı TCKN/VKN': 'Karsi_TCKN_VKN',
  'Karşı Marka Model': 'Karsi_Marka_Model',
  'Karşı Plaka': 'Karsi_Plaka',
  'Karşı Araç': 'Karsi_Arac',
  'Karşı Araç Sürücüsü': 'Karsi_Arac_Surucusu',
  'Karşı Poliçe Türü': 'Karsi_Police_Turu',
  'Karşı Poliçe No': 'Karsi_Police_No',
  'Karşı Poliçe Baş Tarihi': 'Karsi_Police_Bas_Tarihi',
  'Karşı Poliçe Bitiş Tarihi': 'Karsi_Police_Bitis_Tarihi',


  // Kaza / tarih
  'Vekalet Tarihi': 'Vekalet_Tarihi',
  'Kaza Tarihi': 'Kaza_Tarihi',
  'Kaza Saati': 'Kaza_Saati',
  'Kaza Yeri': 'Kaza_Yeri',
  'Kaza Özeti': 'Kaza_Ozeti',
  'Kaza Analiz': 'Kaza_Analiz',
  'İhtar Tarihi': 'Ihtar_Tarihi',
  'Ihtar Tarihi': 'Ihtar_Tarihi',


  // Davalı
  'Davalı Adı': 'Davali_Adi',
  'Davalı Adresi': 'Davali_Adresi',
  'Davalı Mail': 'Davali_Mail',
  'Davalı E-Mail': 'Davali_Mail',
  'Davalı Kep': 'Davali_Kep',
  'Davali Adi': 'Davali_Adi_Lookup',


  // Eksper
  'Eksper Adı': 'Eksper_Adi',
  'Eksper Mail': 'Eksper_Mail',
  'Eksper Telefon': 'Eksper_Telefon',
  'Eksper Rp No': 'Eksper_Rapor_No',
  'Eksper Rp Tarihi': 'Eksper_Rapor_Tarihi',


  // Talepler
  'Kusur Oranı': 'Kusur_Orani',
  'Değer Kaybı Talebi': 'Deger_Kaybi_Talebi',
  'Hasar Farkı Talebi': 'Hasar_Farki_Talebi',
  'AMB Talebi': 'AMB_Talebi',
  'Ekspertiz Bedeli Talebi': 'Ekspertiz_Bedeli_Talebi',
  'Talep Türü': 'Talep_Turu',
  'Talep Kalemleri': 'Talep_Kalemleri',
  // Dropdown (checkboxlar kaldırıldığında buradan beslenecek)
  'Sigorta Alt Brans': 'Sigorta_Alt_Brans',
  'Sigorta Alt Branş': 'Sigorta_Alt_Brans',


  'Talep Tutarı DK': 'Talep_Tutari_DK',
  'Talep Tutarı HF': 'Talep_Tutari_HF',
  'Talep Tutarı AMB': 'Talep_Tutari_AMB',
  'Talep Tutarı Eksper R Ücreti': 'Talep_Tutari_EksperRaporUcreti',
  'Talep Tutarı Toplam': 'Talep_Tutari_Toplam',


  'Hasar Onarım Tutarı': 'Hasar_Onarim_Tutari',


  // İhtar cevap / ödeme
  'İhtar Cevap Durumu': 'Ihtar_Cevap_Durumu',
  'İhtar Cevap Tarihi': 'Ihtar_Cevap_Tarihi',
  'İhtar Ön Ödeme Tutarı': 'Ihtar_On_Odeme_Tutari',
  'İhtar Ön Ödeme Tarihi': 'Ihtar_On_Odeme_Tarihi',
  'Komisyon Oranı': 'On_Odeme_Komisyon_Orani',


  // Masraflar / Servis / Ekler
  'Vekalet Ücreti': 'Masraf_Vekalet_Ucreti',
  'Harç Ücreti': 'Tahkim_Basvuru_Ucreti',
  'Servis Adı': 'Servis_Adi',
  'Servis IBAN': 'Servis_IBAN',
  'Servis Telefon': 'Servis_Telefon',
  'İhtar Dilekçesi Ekler': 'Ihtar_Dilekcesi_Ekler',
  'İhtar Ekler': 'Ihtar_Ekler',
  'Tahkim Deliller': 'Tahkim_Deliller'
};


const DAVALI_DIRECTORY = {
  'AcnTurk Sigorta A.Ş.': 'Fulya Mah. Büyükdere Cad. Quasar No:76 Kat:4 İç Kapı No:142, Şişli / İstanbul',
  'AKSigorta A.Ş.': 'Poligon Cad. Buyaka 2 Sitesi No:8 Kule:1, Kat:0-6 Ümraniye 34771/İstanbul',
  'Allianz Sigorta A.Ş.': 'Allianz Tower, Küçükbakkalköy Mah. Kayışdağı Cad. No:1, 34750 Ataşehir / İstanbul',
  'Anadolu Anonim Türk Sigorta Şirketi (Anadolu Sigorta)': 'Rüzgarlıbahçe Mah. Çam Pınarı Sok. No:6, 34805 Beykoz / İstanbul',
  'Ankara Anonim Türk Sigorta Şirketi': 'Ünalan Mah., Libadiye Cad. No:84/2 Üsküdar / İstanbul',
  'Arex Sigorta A.Ş.': 'Maslak Mah. Maslak Meydan Sk. Veko Giz Plaza No:3 Kat:8 Sarıyer / İstanbul',
  'S.S. Atlas Sigorta Kooperatifi (Atlas Mutuel)': 'Akdeniz Mah. Halit Ziya Bulvarı 1353 Sok. No:2 Kat:6 İç Kapı No:61, Konak / İzmir',
  'AXA Sigorta A.Ş.': 'Meclis-i Mebusan Cad. No:15 34433 Salıpazarı / İstanbul',
  'Bereket Sigorta A.Ş.': 'Saray Mah. Dr. Adnan Büyükdeniz Cad. B Blok No:8 Kat:1-2 34768 Ümraniye / İstanbul',
  'Corpus Sigorta A.Ş.': 'Quick Tower, İçerenköy Mah. Umut Sok. No:10-12 K:8 D:37 Ataşehir - İstanbul',
  'Doğa Sigorta A.Ş.': 'Maslak Spine Tower No:243 Büyükdere Cad. 34398 Sarıyer / İstanbul',
  'Emaa Sigorta A.Ş.': 'Altunizade Mah. Mahir İz Cad. Ofton İş Merkezi 13/2 İç Kapı No:3 Üsküdar / İstanbul',
  'Eureko Sigorta A.Ş.': 'Altunizade Mah. Ord. Prof. Dr. Fahrettin Kerim Gökay Cad. No:20 Üsküdar / İstanbul',
  'GRI Sigorta A.Ş.': 'Karacaoğlan Mah. 6166 Sok. No:32/1, Bornova – İzmir',
  'HDI Sigorta A.Ş.': 'Sahrayıcedit Mah. Batman Sok. No:6 34734 Kadıköy / İstanbul',
  'Hepiyi Sigorta A.Ş.': 'Fatih Sultan Mehmet Mah. Poligon Cad. Buyaka 2 Sitesi No:8 Kule 1 Kat:21 34771 Ümraniye / İstanbul',
  'Koru Sigorta A.Ş.': '19 Mayıs Mah. İnönü Cad. Ali İhsan Tüzün İş Merkezi No:96 Kat:5-6, 34742 Kadıköy / İstanbul',
  'Magdeburger Sigorta A.Ş.': 'İnkılap Mah., Dr. Adnan Büyükdeniz Cad., Akkom Ofispark 2. Blok, K:12, Ümraniye / İstanbul',
  'Mapfre Sigorta A.Ş.': 'Torun Center, Fulya Mah., Büyükdere Cad. No:74-D Şişli / İstanbul',
  'Neova Katılım Sigorta A.Ş.': '',
  'Orient Sigorta A.Ş.': 'Değirmen Sok. No:18 Nida Kule Kat:4 Kozyatağı, Kadıköy / İstanbul',
  'Quick Sigorta A.Ş.': 'Quick Tower, İçerenköy Mah. Umut Sok. No:10-12, 34752 Ataşehir / İstanbul',
  'Prive Sigorta A.Ş.': 'Torun Center D Blok No:74 Kat:12 34394 Şişli / İstanbul',
  'Ray Sigorta A.Ş.': 'Cumhuriyet Mah. Haydar Aliyev Cad. No:28 34457 Sarıyer / İstanbul',
  'Sompo Sigorta A.Ş.': 'Rüzgarlıbahçe Mah. Çam Pınarı Sok. No:10, Kavacık / Beykoz / İstanbul',
  'Şeker Sigorta A.Ş.': 'Büyükdere Cad. No:171 Metrocity A Blok Kat:2 34394 Levent / İstanbul',
  'Türk Nippon Sigorta A.Ş.': 'Altunizade Mah. Mahir İz Cad. No:24, 34662 Üsküdar / İstanbul',
  'Türkiye Katılım Sigorta A.Ş.': 'İnkılap Mah., Dr. Adnan Büyükdeniz Cad., Akkom Ofis Park Kelif Plaza No:2, Kat:16-17, 34768 Ümraniye / İstanbul',
  'Türkiye Sigorta A.Ş.': 'Büyükdere Cad. Güneş Plaza No:110 34394 Esentepe / Şişli / İstanbul',
  'Unico Sigorta A.Ş.': 'Nidakule Göztepe, Merdivenköy Mah. Bora Sok. No:1 Kat:22-24 Kadıköy / İstanbul',
  'Zurich Sigorta A.Ş.': 'Orjin Maslak İş Merkezi, Eski Büyükdere Cad. No:27 Kat:12-13 34485 Sarıyer / İstanbul',
  'Allianz Hayat ve Emeklilik A.Ş.': 'Allianz Tower, Küçükbakkalköy Mah. Kayışdağı Cad. No:1, 34750 Ataşehir / İstanbul',
  'Allianz Yaşam ve Emeklilik A.Ş.': 'Allianz Tower, Küçükbakkalköy Mah. Kayışdağı Cad. No:1, 34750 Ataşehir / İstanbul',
  'AgeSA Hayat ve Emeklilik A.Ş.': 'İçerenköy Mah. Umut Sok. Quick Tower Sitesi No:10-12/9 Kat:1 Ataşehir / İstanbul',
  'Katılım Emeklilik ve Hayat A.Ş.': 'İnkılap Mah. Dr. Adnan Büyükdeniz Cad. Kelif Plaza 3. Blok No:2 İç Kapı No:3 Ümraniye / İstanbul',
  'MetLife Emeklilik ve Hayat A.Ş.': 'Kavacık Ticaret Merkezi Rüzgarlıbahçe Mah. Kavak Sokak B Blok No:18 Kavacık – İstanbul',
  'Türkiye Hayat ve Emeklilik A.Ş.': 'Levent Mah. Çayır Çimen Sok. No:7 34330 Levent / Beşiktaş / İstanbul',
  'Quick Hayat Sigorta A.Ş.': 'Quick Tower İçerenköy Mah. Umut Sok. No:10-12 34752 Ataşehir / İstanbul'
};


function applyDavaliDirectory_(map) {
  const raw = map.Davali_Adi_Lookup;
  if (!hasValue_(raw)) return;
  const key = String(raw).trim();
  if (!Object.prototype.hasOwnProperty.call(DAVALI_DIRECTORY, key)) return;
  map.Davali_Adi = key;
  map.Davali_Adresi = DAVALI_DIRECTORY[key] || '';
}


function applyKeyMap_(out, src) {
  if (!src || typeof src !== 'object') return;
  for (const k in src) {
    if (!Object.prototype.hasOwnProperty.call(src, k)) continue;
    const target = KEYMAP[k];
    if (target) out[target] = src[k];
  }
}


/* ==========================
   TEMPLATE PICK (Ihtar)
   ========================== */


function pickIhtarTemplateId_(cfg, placeholders) {
  if (!hasValue_(placeholders.Vekil_Adi)) return VEKILSIZ_TEMPLATE_ID;
  const dk = isTrue(placeholders.Deger_Kaybi_Talebi);
  const hf = isTrue(placeholders.Hasar_Farki_Talebi);
  const amb = isTrue(placeholders.AMB_Talebi);


  if (amb && cfg.docs_id_Template_AMB_UzmRp_Genel) return String(cfg.docs_id_Template_AMB_UzmRp_Genel).trim();
  if (dk && hf && cfg.docs_id_TemplateIhtar_DK_HF) return String(cfg.docs_id_TemplateIhtar_DK_HF).trim();
  if (dk && cfg.docs_id_TemplateIhtar_DK) return String(cfg.docs_id_TemplateIhtar_DK).trim();
  if (hf && cfg.docs_id_TemplateIhtar_HF) return String(cfg.docs_id_TemplateIhtar_HF).trim();
  if (cfg.docs_id_Template_Ihtar_Genel) return String(cfg.docs_id_Template_Ihtar_Genel).trim();


  throw new Error('Uygun ihtar template id bulunamadı (sheet kolon adlarını kontrol et).');
}

function testAuth() {
  const ss = SpreadsheetApp.openById(TENANT_SHEET_ID);
  Logger.log(ss.getName());
}



