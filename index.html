<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Değer Kaybı SaaS Modülü</title>
  <style>
    :root {
      color-scheme: light;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      --bg: #f7f8fb;
      --card: #ffffff;
      --text: #1d2433;
      --muted: #5f6b7a;
      --primary: #1f6feb;
      --primary-dark: #164fc5;
      --border: #e4e8f0;
      --success: #0a7b42;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    #app {
      min-height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
      border: 1px solid var(--border);
    }

    h1, h2, h3 {
      margin: 0 0 12px;
    }

    p {
      margin: 0 0 12px;
      color: var(--muted);
      line-height: 1.5;
    }

    .stack {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .badge {
      display: inline-flex;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(31, 111, 235, 0.1);
      color: var(--primary);
      font-weight: 600;
      font-size: 12px;
      letter-spacing: 0.3px;
      text-transform: uppercase;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    label {
      font-weight: 600;
      font-size: 14px;
    }

    input[type="file"] {
      padding: 12px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      background: #f9fafc;
    }

    button {
      border: none;
      padding: 14px 18px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      background: var(--primary);
      color: #fff;
      transition: background 0.2s ease;
    }

    button:hover {
      background: var(--primary-dark);
    }

    button:disabled {
      background: #9db8f3;
      cursor: not-allowed;
    }

    .note {
      padding: 12px;
      border-radius: 12px;
      background: #f2f6ff;
      color: var(--muted);
      font-size: 14px;
    }

    .status {
      padding: 12px;
      border-radius: 12px;
      background: #f4f8f3;
      border: 1px solid #c9e7d4;
      color: var(--success);
      font-weight: 600;
      font-size: 14px;
    }

    .list {
      margin: 0;
      padding-left: 20px;
      color: var(--muted);
    }

    .result {
      border: 1px solid #d7e3f8;
      background: #f3f7ff;
      border-radius: 12px;
      padding: 16px;
    }

    .result a {
      display: inline-flex;
      margin-top: 8px;
      color: var(--primary);
      font-weight: 600;
      text-decoration: none;
    }

    @media (min-width: 720px) {
      #app {
        padding: 40px;
        max-width: 860px;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <section class="card stack">
      <span class="badge">SaaS Modülü</span>
      <h1>Değer Kaybı Tahmini &amp; Dilekçe Hazırlama</h1>
      <p>
        Trafik kazası değer kaybı başvurularınız için gerekli evrakları buradan kolayca yükleyin.
        Evraklarınızı aldıktan sonra değer kaybı tahmini ve sigortaya başvuru dilekçesini sizin adınıza hazırlayacağız.
      </p>
      <div class="result" id="resultArea" hidden>
        <strong>Hazırladığımız çıktılar</strong>
        <p id="resultAmount"></p>
        <a id="resultLink" href="#" target="_blank" rel="noopener">Dilekçeyi indir</a>
      </div>
      <div class="stack">
        <div class="input-group">
          <label for="expertReport">Eksper raporu (zorunlu)</label>
          <input id="expertReport" type="file" accept="application/pdf,image/*" required />
          <p class="note">
            Eksper raporunu e-Devlet üzerinden &ldquo;Sigorta Bilgi ve Gözetim Merkezi (SBM)&rdquo; hizmetlerinde
            kaza dosyanızı bularak indirebilirsiniz. Genellikle e-Devlet &gt; Kurumlar &gt; SBM &gt;
            Eksper Raporu / Kaza Dosyası Sorgulama adımlarından erişilir.
          </p>
        </div>
        <div class="input-group">
          <label for="optionalDocs">Diğer evraklar (opsiyonel)</label>
          <input id="optionalDocs" type="file" accept="application/pdf,image/*" multiple />
          <p class="note">
            Ruhsat (siz ve karşı taraf), kaza tespit tutanağı ve sigorta poliçeleri gibi belgeler yüklenebilir.
            Ne kadar çok evrak yüklenirse o kadar sağlıklı sonuç elde edilir.
          </p>
        </div>
      </div>
      <button id="uploadButton" type="button">Evrakları Yükle ve Devam Et</button>
      <div id="statusArea" class="status" hidden>Evraklar hazırlanıyor...</div>
      <div class="note" id="waitingNote" hidden>
        <strong>Bireysel başvuru yapanlar için bilgi:</strong>
        <p>
          İşlemler birkaç dakika sürebilir. Bu süreçte başvurunuz hazırlık aşamasındadır. Değer kaybı konusunda
          sigorta hukuku alanında uzman bir avukatla çalışmak, hak kaybını önlemek açısından önemlidir. Birçok
          uzman avukat, vekâlet ücreti, harç ve bilirkişi giderlerini karşı taraftan tahsil ederek size ek maliyet
          çıkarmadan süreci yönetebilir.
        </p>
        <p>
          Avukatla başvuru yapacak kullanıcılarımız için süreç daha hızlı ilerler; bireysel kullanıcılar ise
          sonuçlanana kadar sistem üzerinden güncel bildirim alacaktır.
        </p>
      </div>
      <ul class="list" id="fileList"></ul>
    </section>
  </div>

  <script>
    // Bubble üzerinden JSON girileceği alan (örnek):
    // const RESULT_DATA_JSON = '{"estimatedAmount":"120.000 TL","petitionUrl":"https://example.com/dilekce.pdf"}';
    const RESULT_DATA_JSON = "";

    const resultArea = document.getElementById("resultArea");
    const resultAmount = document.getElementById("resultAmount");
    const resultLink = document.getElementById("resultLink");

    if (RESULT_DATA_JSON) {
      try {
        const parsed = JSON.parse(RESULT_DATA_JSON);
        if (parsed?.estimatedAmount && parsed?.petitionUrl) {
          resultAmount.textContent = `Tahmini sigorta alacağı: ${parsed.estimatedAmount}`;
          resultLink.href = parsed.petitionUrl;
          resultArea.hidden = false;
        }
      } catch (error) {
        console.warn("RESULT_DATA_JSON parse hatası", error);
      }
    }

    const expertInput = document.getElementById("expertReport");
    const optionalInput = document.getElementById("optionalDocs");
    const uploadButton = document.getElementById("uploadButton");
    const statusArea = document.getElementById("statusArea");
    const waitingNote = document.getElementById("waitingNote");
    const fileList = document.getElementById("fileList");

    const toBase64 = (file) => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });

    const compressIfPossible = async (base64) => {
      if (!("CompressionStream" in window)) {
        return base64;
      }
      const response = await fetch(base64);
      const blob = await response.blob();
      const stream = blob.stream().pipeThrough(new CompressionStream("gzip"));
      const compressed = await new Response(stream).blob();
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(compressed);
      });
    };

    const refreshFileList = (files) => {
      fileList.innerHTML = "";
      files.forEach((file) => {
        const item = document.createElement("li");
        item.textContent = `${file.name} (${Math.round(file.size / 1024)} KB)`;
        fileList.appendChild(item);
      });
    };

    uploadButton.addEventListener("click", async () => {
      const expertFile = expertInput.files?.[0];
      if (!expertFile) {
        alert("Eksper raporu yüklemek zorunludur.");
        return;
      }

      const otherFiles = Array.from(optionalInput.files || []);
      const allFiles = [expertFile, ...otherFiles];

      refreshFileList(allFiles);
      statusArea.hidden = false;
      waitingNote.hidden = false;
      uploadButton.disabled = true;

      try {
        const base64List = [];
        for (const file of allFiles) {
          const base64 = await toBase64(file);
          const compressed = await compressIfPossible(base64);
          base64List.push(compressed);
        }

        window.outputlist1 = base64List;
        window.output1 = "evraklar_hazir";
        window.output2 = new Date().toISOString();
        window.output3 = "";
        window.output4 = "";

        if (typeof window.bubble_fn_evraklar_hazir === "function") {
          window.bubble_fn_evraklar_hazir();
        }

        statusArea.textContent = "Evraklar hazır! Hesaplama süreci başladı.";
      } catch (error) {
        console.error(error);
        statusArea.textContent = "Bir hata oluştu. Lütfen tekrar deneyin.";
      } finally {
        uploadButton.disabled = false;
      }
    });
  </script>
</body>
</html>
